

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Testing “live data” &mdash; scippneutron  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="About scippneutron" href="../about/about.html" />
    <link rel="prev" title="Coding conventions" href="coding-conventions.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/overview.html">Overview: scippneutron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/unit-conversions.html">Unit conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/groupby.html">GroupBy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/from-mantid-to-scipp.html">From Mantid to Scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/instrument-view.html">Instrument view</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/exploring-data.html">Exploring data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/working-with-masks.html">Working with masks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/powder-diffraction.html">Neutron Powder Diffraction</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding-conventions.html">Coding conventions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing “live data”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-containers">Run Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#clean-up">Clean Up</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/about.html">About scippneutron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/contributing.html">Contributing to scippneutron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/release-notes.html">Release Notes</a></li>
</ul>

            
          
    <div style="height: 32px; position: fixed; bottom: 0; left: 15px;">
      Select version:&nbsp;
      <select onchange="location = this.value;"
              style="height: 30px; color: #27a54b; background-color: #403d3d;
                    border: 0px; box-shadow: none;">
        <option value="https://scipp.github.io/scippneutron" selected>latest (unstable)</option>
        <option value="https://scipp.github.io/scippneutron/release/0.1.0">v0.1</option>
      </select>
    </div>
  
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">scippneutron</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Testing “live data”</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/developer/testing-live-data.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="testing-live-data">
<h1>Testing “live data”<a class="headerlink" href="#testing-live-data" title="Permalink to this headline">¶</a></h1>
<p>The ESS data streaming system is based on the Apache Kafka data streaming platform.
Testing <code class="docutils literal notranslate"><span class="pre">scippneutron</span></code>’s interface to this system requires running a Kafka server and
populating it with neutron data. The most convenient way to do this on a developer
machine is to use docker containers.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://docs.docker.com/get-docker/">Install Docker Engine</a> on your system.
If on Linux, do not forget to add your user to the “docker” group,
<a class="reference external" href="https://docs.docker.com/engine/install/linux-postinstall/">see documentation</a>.</p>
<p>Install docker-compose</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>conda install -c docker-compose
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="run-containers">
<h2>Run Containers<a class="headerlink" href="#run-containers" title="Permalink to this headline">¶</a></h2>
<p>To start up Kafka and the <a class="reference external" href="https://github.com/ess-dmsc/nexus-streamer">NeXus Streamer</a>
to populate it with data from the SANS2D instrument at ISIS Neutron Source,
navigate to the <code class="docutils literal notranslate"><span class="pre">docs/developer/live_data</span></code> directory and run</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker-compose up
</pre></div>
</div>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Ctrl+C</span></code> cleanly stops the running containers when you are done.</p>
<p>If you are in doubt whether the containers are working you may want
to use the <a class="reference external" href="https://github.com/ess-dmsc/kafkacow">kafkacow command line tool</a> to query the Kafka server, see
<a class="reference external" href="https://github.com/ess-dmsc/kafkacow#install">installation instructions</a>.</p>
<p>For example, to check data topics on the Kafka server</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kafkacow -L -b localhost
</pre></div>
</div>
</div></blockquote>
<p>you should see output like this</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> brokers:
   broker <span class="m">1</span> at <span class="m">0</span>.0.0.0:9092

<span class="m">10</span> topics:
   <span class="s2">&quot;SANS2D_sampleEnv&quot;</span> with <span class="m">1</span> partitions:
        partition   <span class="m">0</span>  <span class="p">|</span>  Low offset:      <span class="m">0</span>  <span class="p">|</span>  High offset: <span class="m">295782</span> <span class="p">|</span>  leader:  <span class="m">1</span> <span class="p">|</span>  replicas: <span class="m">1</span>,  <span class="p">|</span>  isrs: <span class="m">1</span>,
   <span class="s2">&quot;SANS2D_events&quot;</span> with <span class="m">1</span> partitions:
        partition   <span class="m">0</span>  <span class="p">|</span>  Low offset:      <span class="m">0</span>  <span class="p">|</span>  High offset:   <span class="m">6271</span> <span class="p">|</span>  leader:  <span class="m">1</span> <span class="p">|</span>  replicas: <span class="m">1</span>,  <span class="p">|</span>  isrs: <span class="m">1</span>,
...
</pre></div>
</div>
</div></blockquote>
<p>and you can view the event data with</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kafkacow -C -b localhost -t SANS2D_events
</pre></div>
</div>
</div></blockquote>
<p>output:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>Mon <span class="m">12</span>-Apr-2021 <span class="m">13</span>:30:56.903  <span class="o">||</span>  <span class="m">2021</span>-04-12T13:30:56.903

Timestamp: <span class="m">1618234256903</span> <span class="o">||</span> PartitionID:     <span class="m">0</span> <span class="o">||</span> Offset:    <span class="m">1150</span> <span class="o">||</span> File Identifier: ev42 <span class="o">||</span>
<span class="o">{</span>
  detector_id: <span class="o">[</span>     <span class="m">61985</span>     <span class="m">62379</span>     <span class="m">62126</span>     ... truncated <span class="m">756</span> elements ...     <span class="m">120485</span>   <span class="o">]</span>
  facility_specific_data: <span class="o">{</span>
    proton_charge: <span class="m">0</span>.001098
    run_state: RUNNING
  <span class="o">}</span>
  facility_specific_data_type: ISISData
  message_id: <span class="m">1149</span>
  pulse_time: <span class="m">1618234368838996887</span>
  source_name: NeXus-Streamer
  time_of_flight: <span class="o">[</span>     <span class="m">12379936</span>     <span class="m">14495801</span>     <span class="m">14658190</span>     ... truncated <span class="m">756</span> elements ...     <span class="m">36832880</span>   <span class="o">]</span>
<span class="o">}</span>
...
</pre></div>
</div>
</div></blockquote>
<p>Try using <code class="docutils literal notranslate"><span class="pre">scippneutron.data_stream</span></code>, for example</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">scippneutron</span> <span class="k">as</span> <span class="nn">scn</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">my_stream_func</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">scn</span><span class="o">.</span><span class="n">data_stream</span><span class="p">(</span><span class="s1">&#39;localhost:9092&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;SANS2D_events&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">break</span>  <span class="c1"># just print the first batch of data we receive</span>

<span class="n">streaming_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">my_stream_func</span><span class="p">())</span>
</pre></div>
</div>
</div></blockquote>
<p>Note that the producer container (NeXus-Streamer) must be currently running for you to receive data.
By default the producer container stops running after publishing the contents of the SANS2D file it contains.
If you want it to keep repeating publishing data until you terminate docker-compose then set
<code class="docutils literal notranslate"><span class="pre">single-run</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> in <code class="docutils literal notranslate"><span class="pre">docs/developer/live_data/nexus_streamer_config.ini</span></code>, but note that this
will use more and more disk space until you terminate docker-compose.</p>
</div>
<div class="section" id="clean-up">
<h2>Clean Up<a class="headerlink" href="#clean-up" title="Permalink to this headline">¶</a></h2>
<p>After you are done testing you can clean up the containers and free up used disk space by running</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker rm -v live_data_producer_1
docker rm -v live_data_kafka_1
</pre></div>
</div>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../about/about.html" class="btn btn-neutral float-right" title="About scippneutron" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="coding-conventions.html" class="btn btn-neutral float-left" title="Coding conventions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021 Scipp contributors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    
    <style>
      .wy-nav-content { max-width: 1100px; }
    </style>
  

</body>
</html>